name: Deploy to Server

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch: # Allows manual triggering

jobs:
  deploy:
    # Runs on your self-hosted runner (local server)
    runs-on: self-hosted
    
    steps:
      - name: Deploy with Docker Compose
        run: |
          # Navigate to your project directory on the VM
          # Set SERVER_PATH secret to your project path (e.g., /home/ubuntu/docker-test)
          PROJECT_PATH="${{ secrets.SERVER_PATH }}"
          if [ -z "$PROJECT_PATH" ]; then
            echo "Error: SERVER_PATH secret must be set"
            exit 1
          fi
          cd "$PROJECT_PATH"
          
          # Pull latest code
          git fetch origin
          git pull origin main || git pull origin master
          
          # Rebuild and restart containers
          docker compose down
          docker compose build --no-cache
          docker compose up -d
          
          # Show container status
          docker compose ps

