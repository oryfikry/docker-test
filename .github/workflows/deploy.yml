name: Deploy to Server

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch: # Allows manual triggering

jobs:
  deploy:
    # Runs on your self-hosted runner (local server)
    runs-on: self-hosted
    
    steps:
      - name: Deploy with Docker Compose
        run: |
          # Navigate to your project directory on the VM
          # Set SERVER_PATH secret to your project path (e.g., /home/ubuntu/docker-test)
          PROJECT_PATH="${{ secrets.SERVER_PATH }}"
          
          if [ -z "$PROJECT_PATH" ]; then
            echo "‚ùå Error: SERVER_PATH secret is not set in GitHub Secrets"
            echo "Please set it in: Repository Settings ‚Üí Secrets and variables ‚Üí Actions"
            echo "Example value: /home/ubuntu/docker-test"
            exit 1
          fi
          
          if [ ! -d "$PROJECT_PATH" ]; then
            echo "‚ùå Error: Directory does not exist: $PROJECT_PATH"
            echo "Please check that the SERVER_PATH secret points to the correct directory"
            exit 1
          fi
          
          echo "üìÅ Using project directory: $PROJECT_PATH"
          echo "üë§ Running as user: $(whoami)"
          echo "üìÇ Current directory before cd: $(pwd)"
          
          cd "$PROJECT_PATH"
          echo "üìÇ Current directory after cd: $(pwd)"
          
          # Check permissions
          echo "üîç Checking directory permissions..."
          ls -la | head -5
          
          # Check if git repo exists
          if [ ! -d ".git" ]; then
            echo "‚ö†Ô∏è  Warning: .git directory not found. This might be expected if using a different setup."
          fi
          
          # Pull latest code
          echo "üì• Pulling latest code..."
          git fetch origin || echo "‚ö†Ô∏è  git fetch failed (might need sudo or different permissions)"
          git pull origin main || git pull origin master || echo "‚ö†Ô∏è  git pull failed (might need sudo or different permissions)"
          
          # Rebuild and restart containers
          echo "üê≥ Rebuilding and restarting containers..."
          docker compose down
          docker compose build --no-cache
          docker compose up -d
          
          # Show container status
          echo "‚úÖ Deployment complete. Container status:"
          docker compose ps

